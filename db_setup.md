# Sparky Database Setup & Seeding

This document provides the SQL statements to set up and seed the initial data for the Sparky application database, as outlined in the `backend.md` architecture document. Run these commands in your Supabase SQL Editor.

**IMPORTANT:** This script is designed to completely reset and re-initialize your database schema. It will drop existing tables and data before recreating them. **Do not run this on a production database with live user data.**

## 1. Schema Reset

This section drops all existing tables and custom types to ensure a clean slate for recreation.

```sql
-- Drop tables in reverse order of dependency, using CASCADE to handle dependencies automatically.
DROP TABLE IF EXISTS public.credit_usage CASCADE;
DROP TABLE IF EXISTS public.generations CASCADE;
DROP TABLE IF EXISTS public.notifications CASCADE;
DROP TABLE IF EXISTS public.hairstyles CASCADE;
DROP TABLE IF EXISTS public.users CASCADE;
DROP TABLE IF EXISTS public.tools CASCADE;
DROP TABLE IF EXISTS public.plans CASCADE;

-- Drop dependent types. They are now safe to drop as the tables using them are gone.
DROP TYPE IF EXISTS public.tool_type;
DROP TYPE IF EXISTS public.gender;

-- Drop the cache schema
DROP SCHEMA IF EXISTS cache CASCADE;
```

## 2. Custom Types (ENUMs)

We define custom types for consistency across tables.

```sql
-- Create new types
CREATE TYPE public.tool_type AS ENUM ('TRANSFORMATION', 'FILTER', 'ANALYSIS');
CREATE TYPE public.gender AS ENUM ('male', 'female');
```

## 3. Table Creation & RLS Policies

This section contains the `CREATE TABLE` statements and the Row Level Security (RLS) policies that protect user data.

### `plans`
```sql
CREATE TABLE public.plans (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  monthly_credits INT NOT NULL,
  max_daily_credits INT NOT NULL,
  price_usd NUMERIC(6, 2)
);
ALTER TABLE public.plans ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Plans are publicly viewable" ON public.plans FOR SELECT USING (true);
```

### `users`
```sql
CREATE TABLE public.users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT NOT NULL,
  plan_id BIGINT NOT NULL REFERENCES public.plans(id) DEFAULT 1,
  credits INT NOT NULL DEFAULT 10,
  notification_preferences JSONB NOT NULL DEFAULT 
    '{"promotions": true, "featureUpdates": true, "generalAlerts": true}'
);
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own profile." ON public.users FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update their own profile." ON public.users FOR UPDATE USING (auth.uid() = id);
```

### `tools`
```sql
CREATE TABLE public.tools (
  id TEXT PRIMARY KEY,
  name_key TEXT NOT NULL,
  description_key TEXT NOT NULL,
  type public.tool_type NOT NULL,
  icon_name TEXT NOT NULL,
  cover_image_url TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  sort_order INT DEFAULT 0
);
ALTER TABLE public.tools ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Active tools are publicly readable" ON public.tools FOR SELECT USING (is_active = TRUE);
```

### `generations`
```sql
CREATE TABLE public.generations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  tool_id TEXT NOT NULL REFERENCES public.tools(id),
  image_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
ALTER TABLE public.generations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own generations." ON public.generations FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert their own generations." ON public.generations FOR INSERT WITH CHECK (auth.uid() = user_id);
```

### `credit_usage`
```sql
CREATE TABLE public.credit_usage (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  tool_id TEXT NOT NULL REFERENCES public.tools(id),
  credits_used INT NOT NULL DEFAULT 1,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
ALTER TABLE public.credit_usage ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own credit usage." ON public.credit_usage FOR SELECT USING (auth.uid() = user_id);
```

### `notifications`
```sql
CREATE TABLE public.notifications (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  title_key TEXT NOT NULL,
  message_key TEXT NOT NULL,
  read BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own notifications." ON public.notifications FOR ALL USING (auth.uid() = user_id);
```

### `hairstyles`
```sql
CREATE TABLE public.hairstyles (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  image_url TEXT NOT NULL,
  gender public.gender NOT NULL,
  is_pro BOOLEAN NOT NULL DEFAULT FALSE,
  category TEXT NOT NULL
);
ALTER TABLE public.hairstyles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Hairstyles are publicly readable" ON public.hairstyles FOR SELECT USING (TRUE);
```

### Cache Table
```sql
CREATE SCHEMA IF NOT EXISTS cache;
CREATE TABLE cache.kv_store (
  key TEXT PRIMARY KEY,
  value JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL
);
-- No RLS, accessed by service role key in Edge Functions.
```

## 4. Data Seeding

This section contains the `INSERT` statements to populate the database with initial data.

### `plans` Data
```sql
INSERT INTO public.plans (id, name, monthly_credits, max_daily_credits, price_usd) VALUES
(1, 'Free', 10, 5, NULL),
(3, 'Pro', 100, 50, 10.00),
(4, 'Enterprise', 5000, 5000, NULL)
ON CONFLICT (id) DO UPDATE SET
  name = EXCLUDED.name,
  monthly_credits = EXCLUDED.monthly_credits,
  max_daily_credits = EXCLUDED.max_daily_credits,
  price_usd = EXCLUDED.price_usd;
```

### `tools` Data
```sql
INSERT INTO public.tools (id, name_key, description_key, type, icon_name, sort_order) VALUES
('hairstyle', 'tool.hairstyle.name', 'tool.hairstyle.description', 'TRANSFORMATION', 'SparklesIcon', 1),
('hair-color', 'tool.hair-color.name', 'tool.hair-color.description', 'TRANSFORMATION', 'PaintBrushIcon', 2),
('age', 'tool.age.name', 'tool.age.description', 'FILTER', 'ClockIcon', 3),
('smile', 'tool.smile.name', 'tool.smile.description', 'FILTER', 'HappyFaceIcon', 4),
('analysis', 'tool.analysis.name', 'tool.analysis.description', 'ANALYSIS', 'UserSearchIcon', 5),
('fat', 'tool.fat.name', 'tool.fat.description', 'FILTER', 'SadFaceIcon', 6),
('bald', 'tool.bald.name', 'tool.bald.description', 'FILTER', 'WindIcon', 7),
('beard', 'tool.beard.name', 'tool.beard.description', 'TRANSFORMATION', 'BeardIcon', 8),
('skin-color', 'tool.skin-color.name', 'tool.skin-color.description', 'TRANSFORMATION', 'SkinIcon', 9),
('halloween', 'tool.halloween.name', 'tool.halloween.description', 'FILTER', 'PumpkinIcon', 10),
('eye-color', 'tool.eye-color.name', 'tool.eye-color.description', 'TRANSFORMATION', 'EyeIcon', 11)
ON CONFLICT (id) DO NOTHING;
```

### `hairstyles` Data
-- NOTE: Using placeholder images for demonstration.
```sql
INSERT INTO public.hairstyles (id, name, image_url, gender, is_pro, category) VALUES
---+
-- Female Short
('female-short-1', 'Chic Bob', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/ChicBob', 'female', false, 'Short'),
('female-short-2', 'Pixie Cut', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/PixieCut', 'female', false, 'Short'),
('female-short-3', 'Layered Bob', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/LayeredBob', 'female', true, 'Short'),
('female-short-4', 'French Bob', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/FrenchBob', 'female', true, 'Short'),
('female-short-5', 'Bixie', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/Bixie', 'female', false, 'Short'),
('female-short-6', 'Asymmetrical Bob', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/AsymmetricalBob', 'female', true, 'Short'),
('female-short-7', 'Razor Bob', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/RazorBob', 'female', false, 'Short'),
('female-short-8', 'Micro Bob', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/MicroBob', 'female', true, 'Short'),
('female-short-9', 'Shaggy Pixie', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/ShaggyPixie', 'female', false, 'Short'),
('female-short-10', 'Undercut Pixie', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/UndercutPixie', 'female', true, 'Short'),
('female-short-11', 'Wedge Cut', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/WedgeCut', 'female', false, 'Short'),
('female-short-12', 'Pageboy Revival', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/PageboyRevival', 'female', true, 'Short'),
-- Female Medium
('female-medium-1', 'Shoulder Waves', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/ShoulderWaves', 'female', false, 'Medium'),
('female-medium-2', 'Blunt Cut', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/BluntCut', 'female', true, 'Medium'),
('female-medium-3', 'Lob (Long Bob)', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/Lob_LongBob', 'female', false, 'Medium'),
('female-medium-4', 'Curtain Bangs with Layers', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/CurtainBangsWithLayers', 'female', true, 'Medium'),
('female-medium-5', 'Wolf Cut Medium', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/WolfCutMedium', 'female', true, 'Medium'),

-- Female Long
('female-long-1', 'Wavy Layers', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/WavyLayers', 'female', false, 'Long'),
('female-long-2', 'Sleek Straight', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/SleekStraight', 'female', false, 'Long'),
('female-long-3', 'Voluminous Curls', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/VoluminousCurls', 'female', true, 'Long'),
('female-long-4', 'Butterfly Cut', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/ButterflyCut', 'female', true, 'Long'),
('female-long-5', 'Beachy Boho Waves', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/BeachyBohoWaves', 'female', false, 'Long'),

-- Female Curly
('female-curly-1', 'Tight Curls', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/TightCurls', 'female', false, 'Curly'),
('female-curly-2', 'Afro', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/Afro', 'female', true, 'Curly'),
('female-curly-3', 'Curly Shag', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/CurlyShag', 'female', true, 'Curly'),
('female-curly-4', 'Curly Bangs', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/CurlyBangs', 'female', true, 'Curly'),

-- Female Styled
('female-styled-1', 'Elegant Updo', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/ElegantUpdo', 'female', true, 'Styled'),
('female-styled-2', 'Braided Crown', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/BraidedCrown', 'female', true, 'Styled'),
('female-styled-3', 'Hollywood Waves', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/HollywoodWaves', 'female', true, 'Styled'),
('female-styled-4', 'Sleek Low Bun', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/SleekLowBun', 'female', true, 'Styled'),
('female-styled-5', 'Waterfall Braid', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/WaterfallBraid', 'female', true, 'Styled'),

-- Female Protective
('female-protective-1', 'Box Braids', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/BoxBraids', 'female', true, 'Protective'),
('female-protective-3', 'Passion Twists', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Females/PassionTwists', 'female', true, 'Protective'),

-- Male Short
('male-short-1', 'Crew Cut', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/CrewCut', 'male', false, 'Short'),
('male-short-2', 'Textured Crop', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/TexturedCrop', 'male', true, 'Short'),
('male-short-3', 'Buzz Cut', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/BuzzCut', 'male', false, 'Short'),
('male-short-4', 'Caesar Cut', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/CaesarCut', 'male', true, 'Short'),
('male-short-5', 'Ivy League', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/IvyLeague', 'male', false, 'Short'),

-- Male Medium
('male-medium-1', 'Side Part', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/SidePart', 'male', false, 'Medium'),
('male-medium-2', 'Slick Back', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/SlickBack', 'male', true, 'Medium'),
('male-medium-3', 'Quiff', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/Quiff', 'male', true, 'Medium'),
('male-medium-4', 'Messy Fringe', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/MessyFringe', 'male', false, 'Medium'),
('male-medium-5', 'Korean Two-Block', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/KoreanTwo-Block', 'male', true, 'Medium'),
('male-medium-6', 'Curly Fringe', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/CurlyFringe', 'male', false, 'Medium'),

-- Male Long
('male-long-1', 'Man Bun', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/ManBun', 'male', false, 'Long'),
('male-long-2', 'Long Waves', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/LongWaves', 'male', true, 'Long'),
('male-long-3', 'Viking Length', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/VikingLength', 'male', true, 'Long'),

-- Male Styled
('male-styled-1', 'Pompadour', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/Pompadour', 'male', true, 'Styled'),
('male-styled-2', 'Modern Mullet', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/ModernMullet', 'male', true, 'Styled'),
('male-styled-3', 'Undercut Quiff', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/UndercutQuiff', 'male', true, 'Styled'),
('male-styled-4', 'Slick Side Part', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/SlickSidePart', 'male', false, 'Styled'),

-- Male Fade
('male-fade-1', 'Low Taper Fade', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/LowTaperFade', 'male', false, 'Fade'),
('male-fade-2', 'High Fade with Crop', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/HighFadewithCrop', 'male', true, 'Fade'),
('male-fade-3', 'Drop Fade', 'https://iymyjcmaepnxztsuiebt.supabase.co/storage/v1/object/public/HairCutsImage/Males/DropFade', 'male', false, 'Fade')

ON CONFLICT (id) DO NOTHING;

```

## 5. Storage Bucket Setup

The application requires a storage bucket to be created in your Supabase project. This step is **critical** to prevent "Bucket not found" errors when generating images.

### `generations` Bucket (for AI-generated images)

This bucket stores the output images from the AI tools.

1.  Navigate to the **Storage** section in your Supabase project dashboard.
2.  Click **"Create a new bucket"**.
3.  Set the **Bucket name** to `generations`.
4.  Toggle **"Public bucket"** to **ON**. This allows images to be easily displayed in the app and shared.
5.  Click **"Save"**.

After creating the bucket, you must apply a security policy to control who can upload files.

1.  In the Supabase dashboard, go to **Storage** -> **Policies**.
2.  Find the `generations` bucket and click **"New Policy"**.
3.  Select the **"Create a new policy from scratch"** template.
4.  Set the **Policy name** to `Allow authenticated uploads to own folder`.
5.  Check the box for the **`insert`** operation under "Allowed operations".
6.  For the **Policy definition**, paste the following SQL condition. This ensures a logged-in user can only upload files into a folder path that starts with their own user ID.
    ```sql
    (bucket_id = 'generations' AND (storage.foldername(name))[1] = auth.uid()::text)
    ```
7.  Click **"Review"** and then **"Save policy"**.

## 6. User Profile Trigger

This function and trigger are **essential** for the application to work. They automatically create a public user profile when a new user signs up via Supabase Auth. Without this, users will not be able to log in or use the app.

```sql
-- Create a function to handle new user creation
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  INSERT INTO public.users (id, username)
  VALUES (NEW.id, NEW.raw_user_meta_data ->> 'username');
  RETURN NEW;
END;
$$;

-- Create a trigger to call the function after a new user is created in auth.users
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```